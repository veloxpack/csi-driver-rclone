name: Publish Helm Chart to GHCR

on:
  push:
    tags:
      - 'v*'
  release:
    types: [published]
  pull_request:
    branches:
      - main
    paths:
      - 'charts/**'
      - '.github/workflows/helm-chart-ghcr-release.yaml'

permissions:
  contents: read
  packages: write

env:
  CHART_PATH: charts

jobs:
  lint-and-validate:
    runs-on: ubuntu-latest
    container:
      image: alpine/helm:3.19.0
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: |
          apk add --no-cache yq bash

      - name: Lint chart
        run: |
          set -euo pipefail
          helm lint "${CHART_PATH}" --strict

      - name: Validate chart templates
        run: |
          set -euo pipefail
          helm template test "${CHART_PATH}" > /dev/null

      - name: Extract chart metadata
        id: chart
        run: |
          set -euo pipefail
          CHART_NAME=$(yq eval '.name' "${CHART_PATH}/Chart.yaml")
          CHART_VERSION=$(yq eval '.version' "${CHART_PATH}/Chart.yaml")
          echo "name=${CHART_NAME}" >> "${GITHUB_OUTPUT}"
          echo "version=${CHART_VERSION}" >> "${GITHUB_OUTPUT}"

      - name: Summary
        if: always()
        run: |
          CHART_NAME=$(yq eval '.name' "${CHART_PATH}/Chart.yaml")
          CHART_VERSION=$(yq eval '.version' "${CHART_PATH}/Chart.yaml")
          cat >> "${GITHUB_STEP_SUMMARY}" <<EOF
          ## Helm Chart Validation

          **Chart:** ${CHART_NAME}
          **Version:** ${CHART_VERSION}
          **Status:** âœ… Linting and validation passed
          EOF

  publish-ghcr:
    runs-on: ubuntu-latest
    container:
      image: alpine/helm:3.19.0
    needs: lint-and-validate
    if: github.event_name != 'pull_request'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: |
          apk add --no-cache yq bash

      - name: Determine version
        id: version
        run: |
          set -x  # Enable debug output
          if [[ "${GITHUB_REF}" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
            echo "ðŸ“¦ Using version from tag: ${VERSION}"
            echo "version=${VERSION}" >> "${GITHUB_OUTPUT}"
            # For tagged releases, appVersion should match the tag version
            echo "app_version=${VERSION}" >> "${GITHUB_OUTPUT}"
            echo "âœ… Version set to: ${VERSION}"
            echo "âœ… AppVersion set to: ${VERSION}"
          else
            VERSION=$(yq eval '.version' "${CHART_PATH}/Chart.yaml")
            echo "ðŸ“¦ Using version from Chart.yaml: ${VERSION}"
            echo "version=${VERSION}" >> "${GITHUB_OUTPUT}"
            # Extract appVersion from Chart.yaml
            APP_VERSION=$(yq eval '.appVersion' "${CHART_PATH}/Chart.yaml")
            echo "ðŸ“¦ Using appVersion from Chart.yaml: ${APP_VERSION}"
            echo "app_version=${APP_VERSION}" >> "${GITHUB_OUTPUT}"
            echo "âœ… Version set to: ${VERSION}"
            echo "âœ… AppVersion set to: ${APP_VERSION}"
          fi

      - name: Push Helm chart to GHCR
        id: push
        uses: appany/helm-oci-chart-releaser@v0.5.0
        with:
          name: csi-driver-rclone
          repository: ${{ github.repository_owner }}/charts
          tag: ${{ steps.version.outputs.version }}
          app_version: ${{ steps.version.outputs.app_version }}
          path: ${{ env.CHART_PATH }}
          registry: ghcr.io
          registry_username: ${{ github.actor }}
          registry_password: ${{ secrets.GITHUB_TOKEN }}
          update_dependencies: 'true'

      - name: Summary
        run: |
          cat >> "${GITHUB_STEP_SUMMARY}" <<EOF
          ## ðŸš€ Helm Chart Published to GHCR

          **Image:** \`${{ steps.push.outputs.image }}\`
          **Version:** \`${{ steps.version.outputs.version }}\`

          ### Installation Instructions

          **Install latest version:**
          \`\`\`bash
          helm install csi-rclone oci://ghcr.io/${{ github.repository_owner }}/charts/csi-driver-rclone \\
            --namespace veloxpack --create-namespace
          \`\`\`

          **Install specific version:**
          \`\`\`bash
          helm install csi-rclone oci://ghcr.io/${{ github.repository_owner }}/charts/csi-driver-rclone \\
            --version ${{ steps.version.outputs.version }} \\
            --namespace veloxpack --create-namespace
          \`\`\`

          ### FluxCD HelmRepository

          \`\`\`yaml
          apiVersion: source.toolkit.fluxcd.io/v1
          kind: HelmRepository
          metadata:
            name: csi-driver-rclone
            namespace: flux-system
          spec:
            interval: 1h
            type: oci
            url: oci://ghcr.io/${{ github.repository_owner }}/charts
          \`\`\`

          ### Make Package Public

          ðŸ“ **Important:** By default, packages are private. To make this chart publicly accessible:

          1. Go to: https://github.com/${{ github.repository_owner }}/packages
          2. Click on the \`charts/csi-driver-rclone\` package
          3. Click "Package settings"
          4. Scroll to "Danger Zone"
          5. Click "Change visibility" â†’ Select "Public"
          EOF

